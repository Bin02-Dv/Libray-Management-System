{% extends "members/base.html" %}

{% block title %}Reserve Books{% endblock title %}

{% block content %}

<main class="p-6 md:p-10">
    <h3 class="text-3xl font-bold mb-8">Reserve a Book</h3>
    <div class="grid md:grid-cols-2 gap-10">
        <div class="bg-white p-8 rounded-xl shadow-lg">
            <h4 class="text-xl font-semibold mb-6">Search for a Book</h4>
            <form id="search-form" class="mb-6">
                <input id="search-input" type="text"
                    placeholder="Title, Author, or ISBN..."
                    class="w-full px-6 py-4 border rounded-lg focus:ring-2 focus:ring-blue-600"/>
                <button type="submit"
                        class="mt-4 w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700">
                    Search
                </button>
            </form>
            <div id="search-results" class="border-t pt-6 space-y-6"></div>
        </div>
    </div>
</main>

<script>
const searchForm = document.getElementById('search-form');
const resultsDiv = document.getElementById('search-results');

searchForm.addEventListener('submit', function(e) {
    e.preventDefault();

    const query = document.getElementById('search-input').value;

    fetch(`/books/search/?q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
            resultsDiv.innerHTML = '';

            if (data.results.length === 0) {
                resultsDiv.innerHTML = '<p class="text-gray-500">No books found.</p>';
                return;
            }

            data.results.forEach(book => {
                resultsDiv.innerHTML += `
                    <div class="flex items-center space-x-4">
                        <img src="${book.cover || '/static/img/book-placeholder.png'}"
                             class="w-20 h-28 object-cover rounded"/>
                        <div class="flex-1">
                            <h5 class="font-bold">${book.title}</h5>
                            <p class="text-gray-600">${book.author}</p>
                            ${
                                book.available
                                ? `<span class="text-green-600">Available</span>`
                                : `<span class="text-red-600">Currently Unavailable</span>`
                            }
                        </div>
                    </div>

                    ${
                        book.available
                        ? `<button onclick="reserveBook(${book.id})"
                                   class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700">
                               Place Hold
                           </button>`
                        : ''
                    }
                `;
            });
        });
});

function reserveBook(bookId) {
    const formData = new FormData();
    formData.append('book_id', bookId);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    fetch('/books/reserve/', {
        method: 'POST',
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert('Hold placed successfully!');
            searchForm.dispatchEvent(new Event('submit'));
        } else {
            alert(data.message || 'Unable to reserve book.');
        }
    });
}
</script>

{% endblock content %}